<!-- Branch Management Page -->
<div class="bg-gray-50 h-full overflow-y-auto min-h-screen">
  <div class="p-4 md:p-6">

    <!-- Breadcrumb -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a routerLink="/dashboard" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
            </svg>
            Home
          </a>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Branch Management</span>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Branch Management</h1>
          <p class="text-gray-600 mt-2 text-sm">Create, edit, and manage all branch audit records</p>
          <p class="text-xs text-gray-500 mt-1">Total Branches: {{ branches.length }} | Showing:  {{ filteredBranches.length }}</p>
        </div>
        <div class="mt-4 md:mt-0 flex gap-2">
          <button (click)="refreshData()" [disabled]="loading"
            class="inline-flex items-center px-4 py-2 text-sm font-medium bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition shadow-sm">
            <svg class="w-4 h-4 mr-2" [ngClass]="{'animate-spin': loading}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh Data
          </button>
          <button (click)="openAddModal()"
            class="inline-flex items-center px-4 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-sm">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add New Branch
          </button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Branch Section -->
    <div *ngIf="showModal" class="max-w-3xl mx-auto mb-8 rounded-xl border border-gray-200 bg-white shadow-lg p-6 transition-all">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-900">
          {{ isEditMode ? 'Edit Branch Details' : 'Add New Branch' }}
        </h3>
        <button (click)="closeModal()" class="text-gray-400 hover:text-gray-500">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form class="space-y-6" (ngSubmit)="saveBranch()">
        <!-- Basic Information -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Store Name *</label>
              <input type="text" [(ngModel)]="branchForm.StoreName" name="storeName" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
              <input type="text" [(ngModel)]="branchForm.City" name="city" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Date of Visit *</label>
              <input type="date" [(ngModel)]="branchForm['Date of Visit']" name="dateOfVisit" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus: ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Mystery Shopper Name *</label>
              <input type="text" [(ngModel)]="branchForm['Mystery Shopper Name']" name="shopperName" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
          </div>
        </div>
        <!-- Hygiene & Quality -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Hygiene & Quality Scores</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Overall Hygiene (1-5) *</label>
              <input type="number" min="1" max="5" step="0.1" [(ngModel)]="branchForm['Overall Hygiene']" name="overallHygiene" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus: ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Staff Behavior</label>
              <select [(ngModel)]="branchForm['Staff Behavior']" name="staffBehavior"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="Excellent">Excellent</option>
                <option value="Good">Good</option>
                <option value="Average">Average</option>
                <option value="Poor">Poor</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Greeted within 5 seconds</label>
              <select [(ngModel)]="branchForm['Greeted within 5 seconds']" name="greeted"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Store Conditions -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Store Conditions</h4>
          <div class="grid grid-cols-1 md: grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Showcases Clean</label>
              <select [(ngModel)]="branchForm['Showcases clean']" name="showcasesClean"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Music Volume Appropriate</label>
              <select [(ngModel)]="branchForm['Music volume appropriate']" name="musicVolume"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Lighting Appealing</label>
              <select [(ngModel)]="branchForm['Lighting appealing']" name="lighting"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">AC Comfortable</label>
              <select [(ngModel)]="branchForm['AC comfortable']" name="acComfortable"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus: ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Training Focus -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Additional Notes</h4>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Training Focus for this store</label>
            <textarea [(ngModel)]="branchForm['Training Focus for this store: ']" name="trainingFocus" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus: ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          </div>
        </div>
        <!-- Footer Actions -->
        <div class="flex flex-row-reverse gap-2 mt-4">
          <button type="button" (click)="saveBranch()" [disabled]="saving"
            class="inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover: bg-indigo-700 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">
            {{ saving ? 'Saving...' : (isEditMode ? 'Save Changes' : 'Add Branch') }}
          </button>
          <button type="button" (click)="closeModal()"
            class="inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover: bg-gray-50 focus: ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
      <div class="grid grid-cols-1 md: grid-cols-2 lg:grid-cols-5 gap-4">
        <!-- Search -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" placeholder="Search by store name, city, or shopper..."
              class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          </div>
        </div>
        <!-- Filter by City -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
          <select [(ngModel)]="filterCity" (ngModelChange)="applyFilters()"
            class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <option value="">All Cities</option>
            <option *ngFor="let city of cities" [value]="city">{{ city }}</option>
          </select>
        </div>
        <!-- Filter by Hygiene -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Min Hygiene</label>
          <select [(ngModel)]="filterHygiene" (ngModelChange)="applyFilters()"
            class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus: ring-indigo-500 focus:border-indigo-500 text-sm">
            <option value="">All Scores</option>
            <option value="4">4+ (Excellent)</option>
            <option value="3">3+ (Good)</option>
            <option value="2">2+ (Fair)</option>
            <option value="1">1+ (Poor)</option>
          </select>
        </div>
        <!-- Clear Filters -->
        <div class="flex items-end">
          <button (click)="clearFilters()"
            class="w-full px-4 py-2 text-sm font-medium bg-gray-100 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Clear Filters
          </button>
        </div>
      </div>
      <!-- Export Buttons -->
      <div class="mt-4 pt-4 border-t border-gray-200 flex gap-2">
        <button (click)="exportToCSV()"
          class="inline-flex items-center px-3 py-1.5 text-xs font-medium bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100 transition">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Export CSV
        </button>
        <button (click)="exportToJSON()"
          class="inline-flex items-center px-3 py-1.5 text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 transition">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Export JSON
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="flex justify-center items-center py-12">
      <div class="text-center">
        <svg class="animate-spin h-12 w-12 text-indigo-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600">Loading branches...</p>
      </div>
    </div>

    <!-- Table -->
    <div *ngIf="! loading" class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th (click)="toggleSort('name')" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                <div class="flex items-center">
                  Store Name
                  <svg *ngIf="sortBy === 'name'" class="w-4 h-4 ml-1" [ngClass]="{'rotate-180':  sortDirection === 'desc'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </div>
              </th>
              <th (click)="toggleSort('city')" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                <div class="flex items-center">
                  City
                  <svg *ngIf="sortBy === 'city'" class="w-4 h-4 ml-1" [ngClass]="{'rotate-180': sortDirection === 'desc'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </div>
              </th>
              <th (click)="toggleSort('date')" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                <div class="flex items-center">
                  Visit Date
                  <svg *ngIf="sortBy === 'date'" class="w-4 h-4 ml-1" [ngClass]="{'rotate-180': sortDirection === 'desc'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </div>
              </th>
              <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Shopper</th>
              <th (click)="toggleSort('hygiene')" class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                <div class="flex items-center">
                  Hygiene
                  <svg *ngIf="sortBy === 'hygiene'" class="w-4 h-4 ml-1" [ngClass]="{'rotate-180':  sortDirection === 'desc'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </div>
              </th>
              <th class="px-6 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let branch of paginatedBranches; let i = index" class="hover:bg-gray-50 transition">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-semibold text-gray-900">{{ branch.StoreName }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ branch.City }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ formatDate(branch['Date of Visit']) }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ branch['Mystery Shopper Name'] }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span [ngClass]="getHygieneClass(branch['Overall Hygiene'])" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold">
                  {{ branch['Overall Hygiene'] }}/5
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button (click)="openEditModal(branch, i)" class="text-indigo-600 hover:text-indigo-900 mr-3">
                  <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button (click)="deleteBranch(i)" class="text-red-600 hover:text-red-900">
                  <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </td>
            </tr>
            <tr *ngIf="paginatedBranches.length === 0">
              <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-. 707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="text-lg font-medium">No branches found</p>
                <p class="text-sm mt-1">Try adjusting your filters or add a new branch</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- Pagination -->
      <div *ngIf="totalPages > 1" class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
        <div class="text-sm text-gray-700">
          <!-- Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ Math.min(currentPage * itemsPerPage, filteredBranches.length) }} of {{ filteredBranches. length }} results -->
        </div>
        <div class="flex gap-2">
          <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1"
            [ngClass]="{'opacity-50 cursor-not-allowed': currentPage === 1}"
            class="px-3 py-1 text-sm font-medium bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            Previous
          </button>
          <button *ngFor="let page of [].constructor(totalPages); let i = index"
                  (click)="changePage(i + 1)"
                  [ngClass]="{'bg-indigo-600 text-white': currentPage === i + 1, 'bg-white text-gray-700': currentPage !== i + 1}"
                  class="px-3 py-1 text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            {{ i + 1 }}
          </button>
          <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages"
            [ngClass]="{'opacity-50 cursor-not-allowed':  currentPage === totalPages}"
            class="px-3 py-1 text-sm font-medium bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            Next
          </button>
        </div>
      </div>
    </div>
    
  </div>
</div>