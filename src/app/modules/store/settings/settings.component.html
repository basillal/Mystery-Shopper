<!-- Settings Management Page -->
<div
  class="bg-gray-50 h-[100dvh] md:h-[calc(100dvh-2rem)] flex flex-col overflow-hidden md:rounded-xl md:m-4 border-none md:border md:border-gray-200 shadow-none md:shadow-sm">

  <!-- Fixed Header Section -->
  <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm z-10 flex-shrink-0">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

      <!-- Title & Breadcrumb -->
      <div>
        <nav class="flex mb-1" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-1 md:space-x-2 text-xs text-gray-500 font-medium">
            <li class="inline-flex items-center">
              <a routerLink="/dashboard" class="hover:text-gray-900 transition flex items-center">
                Dashboard
              </a>
            </li>
            <li>
              <span class="mx-1 text-gray-400">/</span>
            </li>
            <li>
              <span class="text-gray-900">Settings</span>
            </li>
          </ol>
        </nav>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Data Management</h1>
      </div>

      <!-- Main Actions -->
      <div class="flex items-center gap-3">
        <div
          class="hidden md:flex items-center px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-semibold border border-blue-100">
          <span class="w-2 h-2 rounded-full bg-blue-500 mr-2 animate-pulse"></span>
          {{ branches.length }} Records
        </div>
        <div class="h-8 w-px bg-gray-200 mx-1 hidden md:block"></div>
        <button (click)="refreshData()" [disabled]="loading"
          class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition" title="Refresh Data">
          <svg class="w-5 h-5" [ngClass]="{'animate-spin': loading}" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
            </path>
          </svg>
        </button>
        <button (click)="openAddModal()"
          class="px-4 py-2 bg-gray-900 hover:bg-black text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transition-all flex items-center transform active:scale-95">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Record
        </button>
      </div>
    </div>

    <!-- Filters Toolbar -->
    <div class="mt-4 flex flex-col md:flex-row gap-3 items-center justify-between">
      <!-- Search -->
      <div class="relative w-full md:w-72 group">
        <span
          class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 group-focus-within:text-blue-500 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </span>
        <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()"
          placeholder="Search stores, cities..."
          class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition shadow-sm placeholder-gray-400">
      </div>

      <!-- Filters & Export -->
      <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 no-scrollbar">
        <select [(ngModel)]="filterCity" (ngModelChange)="applyFilters()"
          class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-gray-200 focus:border-gray-400 cursor-pointer hover:border-gray-300 transition shadow-sm min-w-[120px]">
          <option value="">All Cities</option>
          <option *ngFor="let city of cities" [value]="city">{{ city }}</option>
        </select>

        <select [(ngModel)]="filterHygiene" (ngModelChange)="applyFilters()"
          class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-gray-200 focus:border-gray-400 cursor-pointer hover:border-gray-300 transition shadow-sm min-w-[120px]">
          <option value="">All Ratings</option>
          <option value="4">4+ Excellent</option>
          <option value="3">3+ Good</option>
          <option value="2">2+ Fair</option>
          <option value="1">1+ Poor</option>
        </select>

        <div class="h-6 w-px bg-gray-200 mx-1 hidden md:block"></div>

        <button (click)="exportToCSV()"
          class="px-3 py-2 bg-white border border-gray-200 text-gray-600 hover:text-gray-900 hover:border-gray-300 rounded-lg text-sm font-medium transition shadow-sm flex items-center whitespace-nowrap">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Export CSV
        </button>
      </div>
    </div>
  </div>

  <!-- Scrollable Content Area -->
  <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 custom-scrollbar pb-32">

    <!-- Loading State -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center h-64 fade-in">
      <div class="spinner w-10 h-10 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin mb-4"></div>
      <p class="text-gray-500 font-medium">Syncing data...</p>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && paginatedBranches.length === 0"
      class="flex flex-col items-center justify-center h-64 text-center fade-in">
      <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4">
        <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900">No records found</h3>
      <p class="text-gray-500 text-sm mt-1 mb-4">Try adjusting your filters or search terms.</p>
      <button (click)="clearFilters()"
        class="text-blue-600 hover:text-blue-800 text-sm font-medium hover:underline">Clear all filters</button>
    </div>

    <!-- Desktop Table View -->
    <div *ngIf="!loading && paginatedBranches.length > 0"
      class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mb-6 hidden md:block">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Store
                Details</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Visit
                Date</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                Shopper</th>
              <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                Hygiene</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">
                Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            <tr *ngFor="let branch of paginatedBranches; let i = index"
              class="hover:bg-gray-50/80 transition duration-150">
              <!-- Store -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div
                    class="w-8 h-8 rounded bg-indigo-50 flex-shrink-0 flex items-center justify-center text-indigo-600 font-bold border border-indigo-100 mr-3 text-xs">
                    {{ branch.StoreName.charAt(0) }}
                  </div>
                  <div>
                    <div class="text-sm font-bold text-gray-900">{{ branch.StoreName }}</div>
                    <div class="text-xs text-gray-500">{{ branch.City }}</div>
                  </div>
                </div>
              </td>

              <!-- Date -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="text-xs bg-gray-50 text-gray-700 px-2 py-1 rounded border border-gray-100 font-medium font-mono">
                  {{ formatDate(branch['Date of Visit']) }}
                </span>
              </td>

              <!-- Shopper -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div
                    class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-500 mr-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                  </div>
                  <span class="text-sm text-gray-700 truncate max-w-[150px]">{{ branch['Mystery Shopper Name'] }}</span>
                </div>
              </td>

              <!-- Score -->
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span [ngClass]="getHygieneClass(branch['Overall Hygiene'])"
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-current bg-opacity-10">
                  {{ branch['Overall Hygiene'] }}
                </span>
              </td>

              <!-- Actions -->
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                  <button (click)="openEditModal(branch, i)"
                    class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition border border-blue-100 group"
                    title="Edit">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                      </path>
                    </svg>
                  </button>
                  <button (click)="deleteBranch(i)"
                    class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition border border-red-100 group"
                    title="Delete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                      </path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Card View -->
    <div *ngIf="!loading && paginatedBranches.length > 0" class="md:hidden space-y-4 mb-6">
      <div *ngFor="let branch of paginatedBranches; let i = index"
        class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative">

        <!-- Header: Store & Actions -->
        <div class="flex justify-between items-start mb-3">
          <div class="flex items-center">
            <div
              class="w-10 h-10 rounded-lg bg-indigo-50 flex-shrink-0 flex items-center justify-center text-indigo-600 font-bold border border-indigo-100 mr-3">
              {{ branch.StoreName.charAt(0) }}
            </div>
            <div>
              <div class="text-sm font-bold text-gray-900">{{ branch.StoreName }}</div>
              <div class="text-xs text-gray-500">{{ branch.City }}</div>
            </div>
          </div>
          <!-- Mobile Actions -->
          <div class="flex gap-1">
            <button (click)="openEditModal(branch, i)" class="p-2 text-blue-600 bg-blue-50 rounded-lg"><svg
                class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                </path>
              </svg></button>
            <button (click)="deleteBranch(i)" class="p-2 text-red-600 bg-red-50 rounded-lg"><svg class="w-4 h-4"
                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                </path>
              </svg></button>
          </div>
        </div>

        <!-- Info Grid -->
        <div class="grid grid-cols-2 gap-3 text-xs border-t border-gray-100 pt-3">
          <div>
            <span class="text-gray-400 font-bold uppercase block mb-1">Date</span>
            <span class="font-medium text-gray-800">{{ formatDate(branch['Date of Visit']) }}</span>
          </div>
          <div>
            <span class="text-gray-400 font-bold uppercase block mb-1">Score</span>
            <span [ngClass]="getHygieneClass(branch['Overall Hygiene'])"
              class="inline-flex items-center px-2 py-0.5 rounded-full font-medium border border-current bg-opacity-10">
              {{ branch['Overall Hygiene'] }}/5
            </span>
          </div>
          <div class="col-span-2">
            <span class="text-gray-400 font-bold uppercase block mb-1">Shopper</span>
            <span class="font-medium text-gray-800">{{ branch['Mystery Shopper Name'] }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Shared Pagination -->
    <div *ngIf="totalPages > 1" class="flex md:hidden justify-center pb-8">
      <!-- Added pb-24 for extra bottom space on mobile -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-1 flex items-center gap-1">
        <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1"
          class="w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100 disabled:opacity-50 transition">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <span class="text-sm font-medium text-gray-600 px-4">Page {{ currentPage }} of {{ totalPages }}</span>
        <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages"
          class="w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100 disabled:opacity-50 transition">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal (Same as before, ensuring clean separation) -->
<div *ngIf="showModal"
  class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-sm transition-opacity fade-in">
  <div
    class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all scale-100 border border-gray-100 mt-32 md:mt-0">

    <!-- Modal Header -->
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
      <div>
        <h3 class="text-lg font-bold text-gray-900">{{ isEditMode ? 'Edit Record' : 'New Audit Record' }}</h3>
        <p class="text-xs text-gray-500">Enter details below</p>
      </div>
      <button (click)="closeModal()"
        class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body (Scrollable) -->
    <div class="overflow-y-auto p-6 space-y-6 flex-1 custom-scrollbar">
      <form (ngSubmit)="saveBranch()" id="branchForm">
        <!-- Basic Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div class="space-y-1">
            <label class="text-xs font-semibold text-gray-500 uppercase">Store Name</label>
            <input type="text" [(ngModel)]="branchForm.StoreName" name="storeName" required
              class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-gray-900 focus:bg-white transition">
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-gray-500 uppercase">City</label>
            <input type="text" [(ngModel)]="branchForm.City" name="city" required
              class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-gray-900 focus:bg-white transition">
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-gray-500 uppercase">Date</label>
            <input type="date" [(ngModel)]="branchForm['Date of Visit']" name="dateOfVisit" required
              class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-gray-900 focus:bg-white transition">
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-gray-500 uppercase">Shopper</label>
            <input type="text" [(ngModel)]="branchForm['Mystery Shopper Name']" name="shopperName" required
              class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-gray-900 focus:bg-white transition">
          </div>
        </div>

        <div class="h-px bg-gray-100 my-2"></div>

        <!-- Checkbox Grid -->
        <div class="grid grid-cols-2 gap-3">
          <div
            *ngFor="let item of [{'key': 'Showcases clean', 'label': 'Clean Showcases'}, {'key': 'Music volume appropriate', 'label': 'Appropriate Music'}, {'key': 'Lighting appealing', 'label': 'Good Lighting'}, {'key': 'AC comfortable', 'label': 'AC Comfortable'}]"
            class="p-3 border border-gray-200 rounded-xl flex items-center justify-between cursor-pointer hover:border-blue-300 hover:bg-blue-50/30 transition group"
            (click)="branchForm[item.key] = branchForm[item.key] === 'Yes' ? 'No' : 'Yes'">
            <span class="text-xs font-semibold text-gray-600 group-hover:text-blue-700">{{ item.label }}</span>
            <div class="w-4 h-4 rounded-full border border-gray-300 flex items-center justify-center transition-colors"
              [ngClass]="{'bg-blue-500 border-blue-500': branchForm[item.key] === 'Yes'}">
              <svg *ngIf="branchForm[item.key] === 'Yes'" class="w-3 h-3 text-white" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="space-y-1 mt-4">
          <label class="text-xs font-semibold text-gray-500 uppercase">Hygiene Score (1-5)</label>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="branchForm['Overall Hygiene']"
            name="overallHygiene"
            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-900">
          <div class="flex justify-between text-xs text-gray-400 font-mono mt-1">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
          </div>
          <div class="text-center font-bold text-lg text-gray-900 mt-[-20px] pointer-events-none">{{ branchForm['Overall
            Hygiene'] }}</div>
        </div>

        <div class="space-y-1 mt-4">
          <label class="text-xs font-semibold text-gray-500 uppercase">Notes</label>
          <textarea [(ngModel)]="branchForm['Training Focus for this store:']" name="trainingFocus" rows="2"
            class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-gray-900 transition"></textarea>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
      <button (click)="closeModal()"
        class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition text-sm">Cancel</button>
      <button (click)="saveBranch()" [disabled]="saving"
        class="px-6 py-2 bg-gray-900 text-white font-semibold rounded-lg hover:bg-gray-800 transition text-sm shadow-md flex items-center">
        <svg *ngIf="saving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        {{ saving ? 'Saving...' : 'Save Record' }}
      </button>
    </div>

  </div>
</div>